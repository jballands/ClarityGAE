// Generated by CoffeeScript 1.7.1
(function() {
  var apiCall, formSubmit, root, sessionContinue, sessionSwitch;

  root = this;

  root.session = '';

  root.titlebarContracted = '50px';

  root.titlebarExpanded = '38%';

  $(function() {
    var request, session;
    ($("#claritylogobar")).css("height", root.titlebarExpanded);
    ($("#form_login")).submit(formSubmit);
    ($("#button_continue")).click(sessionContinue);
    ($("#button_switch")).click(sessionSwitch);
    session = $.cookies.get("clarity-console-session");
    root.session = session;
    if (!session) {
      ($("#div_login")).show();
      return;
    }
    request = apiCall("/api/session_get", {
      "id": session
    });
    request.fail(function() {
      $.cookies.del("clarity-console-session");
      ($("#div_login")).show();
    });
    return request.done(function(data) {
      var lazy;
      if (data["closed"]) {
        sessionSwitch();
        return;
      }
      ($("#text_continue")).text("Welcome back.");
      ($("#div_continue")).show();
      lazy = apiCall("/api/provider_get", {
        "token": root.session,
        "id": data["user"]
      }, true);
      return lazy.done(function(data) {
        ($("#text_continue")).html("Welcome back, <strong>" + data['name_first'] + " " + data['name_last'] + "</strong>.");
        return ($("#button_switch")).prop("disabled", false);
      });
    });
  });

  apiCall = function(url, data, lazy, method, context) {
    if (data == null) {
      data = {};
    }
    if (lazy == null) {
      lazy = false;
    }
    if (method == null) {
      method = 'POST';
    }
    if (context == null) {
      context = document.body;
    }
    if (!lazy) {
      $('.load-disable').prop('disabled', true);
      $('#loader').show();
    }
    return $.ajax({
      'url': url,
      'type': method,
      'contentType': 'application/json; charset=utf-8',
      'dataType': 'json',
      'context': context,
      'data': JSON.stringify(data),
      'error': function(xhr, status, error) {
        if (!lazy) {
          return bootbox.alert(xhr.responseText);
        }
      },
      'complete': function() {
        if (!lazy) {
          $('#loader').hide();
          return $('.load-disable').prop('disabled', false);
        }
      }
    });
  };

  formSubmit = function() {
    var form_data, request;
    form_data = {
      'console': true,
      'username': ($("input[name=username]")).val(),
      'password': ($("input[name=password]")).val()
    };
    request = apiCall("/api/session_begin", form_data);
    request.done(function(data) {
      $.cookies.set("clarity-console-session", data["token"]);
      return sessionContinue();
    });
    return false;
  };

  sessionContinue = function() {
    var complete;
    ($("#container")).hide();
    ($("#claritylogobar")).animate({
      "height": root.titlebarContracted
    }, complete = function() {
      window.location = "/console";
    });
  };

  sessionSwitch = function() {
    $.cookies.del("clarity-console-session");
    ($("#div_continue")).hide();
    return ($("#div_login")).show();
  };

}).call(this);
