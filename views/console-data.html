<div class="tab-pane fade" id="tab-data">
    <br>

    <!-- Button row for selecting model -->
    <div class="row">

        <div class="col-md-5 col-md-offset-1">
            <div class="panel panel-default">
                <div class="panel-heading"><span class="glyphicon glyphicon-tasks"></span> Data types <span class="pull-right"><em>Click to change or reload</em></span></div>
                <div class="panel-body" id="data_buttonRow" style="text-align: center;">
                    <button class="btn btn-primary" disabled>Loading...</button>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <span class="glyphicon glyphicon-wrench"></span> Data Controls
                </div>
                <div class="panel-body" style="text-align: center;">

                    <button class="btn btn-primary load-disable" id="data_buttonDeleteRecord">
                        <span class="glyphicon glyphicon-fire"></span>
                        Delete Selected
                    </button>

                    <button class="btn btn-primary load-disable" id="data_buttonCreateRecord">
                        <span class="glyphicon glyphicon-plus"></span>
                        Create New
                    </button>

                    <button class="btn btn-primary load-disable" id="data_buttonRefresh">
                        <span class="glyphicon glyphicon-refresh"></span>
                        Refresh
                    </button>

                </div>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="panel panel-info">
                <div class="panel-heading"><span class="glyphicon glyphicon-filter"></span> Data Filters</div>
                <div class="panel-body">
                    
                    <div class="col-md-4">
                        <select class="form-control load-disable" id="data_filterSelect">
                            <option value="" selected disabled>Field</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control load-disable" id="data_filterInput" placeholder="Value" />
                    </div>
                    <div class="col-md-1">
                        <label>
                            <input type="checkbox" class="form-control load-disable" id="data_filterInput" style="height:1em;" disabled/> Exactly
                        </label>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-info btn-block load-disable" id="data_buttonFilter" disabled>Add Filter</button>
                    </div>


                </div>
                <div class="panel-footer" id="data_filterList">
                    <div class="row">
                        <div class="col-md-10 col-md-offset-1">

                            <div class="alert alert-info">
                                This is an example <strong>filter</strong>. This is what a real <em>filter</em> will look like once they are implemented. But for now, they are just a <code>WIP</code>.
                                <button class="btn btn-xs btn-default pull-right" data-dismiss="alert">Remove</button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loader" id="data_loader" style="margin-left:auto;margin-right:auto;" hidden>
    </div>

    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="table-responsive">
                <table class="table table-striped table-condensed table-bordered" id="data_table">
                    <thead id="data_tableHead">
                    </thead>
                    <tbody id="data_tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="data_modalCreateRecord" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Insert a New Record</h4>
            </div>
            <div class="modal-body">
                <blockquote><em>Be aware that newly inserted records may take some time to propagate through the database (typically less than 1 minute).<br>
                <br>
                Required items are marked with an exclamation.</em></blockquote>
                <table class="table table-striped table-bordered" id="data_modalCreateRecordTable">
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="data_buttonCreateRecordSubmit">Submit</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="data_modalView" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">View a Linked Record</h4>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-striped" id="data_modalViewTable">
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style type="text/css">
    th, td {
        text-align: center; 
        vertical-align: middle;
    }
</style>

<script type="text/javascript">
    var data_config = {};
    var data_current = '';

    function data_errorHandler(xhr, status, error) {
        var template = '<h4>An error occurred while trying to process your request.</h4><br><div class="alert alert-warning"><small><em>{0}</em><br>{1}</small></div>';
        bootbox.alert(String.format(template, status, error));
    }

    function data_init() {
        $('#data_buttonRow .btn').remove();

        for (i in data_config.models) {
            var model = data_config.models[i];
            var modelName = data_config.names[model];
            var markup = String.format('<button class="buttonModelLoad btn btn-default load-disable" model="{0}">{1}</button>&nbsp;', model, modelName);
            $('#data_buttonRow').append(markup);
        }

        $('.buttonModelLoad').click(function() {
            data_dataLoad($(this).attr('model'));
        });
    }

    function data_dataLoad(model, query, offset) {
        $('.load-disable').prop('disabled', true);
        $('#data_tableHead').children().remove();
        $('#data_tableBody').children().remove();
        $('#data_loader').prop('hidden', false);

        if (typeof(model) != 'string') {
            model = data_current;
        }

        data_current = model;

        var url = String.format('/api/{0}_get', model);

        $.ajax({
            'url': url,
            'dataType': 'json',
            'data': {
                'token': session
            },
            'success': data_dataParse,
            'error': data_errorHandler,
            'complete': function() {
                $('.load-disable').prop('disabled', false);
                $('#data_loader').prop('hidden', true);
            }
        })
    }

    //Bind the refresh button to the dataLoad function.
    $('#data_buttonRefresh').click(data_dataLoad);

    function data_dataParse(data, status, xhr) {
        var model = data_current;
        var properties = data_config.properties[model];

        //Grab table head and body elements.
        var tableHead = $('#data_tableHead');
        var tableBody = $('#data_tableBody');

        //Add head cell for checkbox column.
        tableHead.append('<td>&nbsp;<span class="glyphicon glyphicon-ok"></span>&nbsp;</td>');

        //Iterate and insert head cells.
        for (i in properties) {
            var property = properties[i];
            var markup = String.format('<th><small>{0}</small></th>', property.name.toUpperCase());
            tableHead.append(markup);
        }

        //Let's start loading the data into the table! ;D
        for (i in data) {
            var record = data[i];

            //Create a row with the id the same as the record. Makes for easy handling later on.
            var row = $('<tr></tr>').appendTo(tableBody);
            row.attr('id', record.id);

            //Insert a cell with a checkbox...
            var cell = $('<td></td>').appendTo(row);
            var checkbox = $('<input type="checkbox" class="data_tableCheck">').appendTo(cell);
            checkbox.attr('value', record.id);

            //Let's iterate over the properties again so we can get their values!
            for (j in properties) {
                var property = properties[j];
                var cell = $('<td></td>').appendTo(row);

                //Hand it off to another function for the sake of modularity.
                data_makeEditable(cell, record, property);
            }
        }

        //Enable the Create and Delete buttons as well as all the filter controls
        $('#data_buttonCreateRecord, #data_buttonDeleteRecord').prop('disabled', false);
        $('#data_filterSelect, #data_filterInput, #data_buttonFilter').prop('disabled', false);
    }

    function data_makeEditable(cell, record, property, empty) {
        var value = null;
        if (!empty) {
            value = record[property.name];
        }

        //Convert booleans to strings, because ceditable is kind of a witch.
        if (typeof(value) == 'boolean') {
            value = JSON.stringify(value);
        }

        //This switch will deal with properties that can't or shouldn't be edited in the console.
        switch (property.type) {

            case 'copyme':
                //Create a readonly text entry that allows the user to easily copy the id of the record.
                var entry = $('<input type="text" readonly/>').appendTo(cell)
                entry.val(value);
                entry.css('width', '100%');
                entry.tooltip({
                    'placement': 'right',
                    'title': 'Click, then Ctrl+C to copy'
                });
                //Make it auto-select all text when clicked on.
                entry.click(function() { $(this).select(); });
                return;

            case 'readonly':
                cell.append(value);
                return;

            case 'headshot':
                if (value == null) {
                    cell.append('<span class="glyphicon glyphicon-remove"></span>');
                }
                else {
                    var markup = '<button class="btn btn-sm btn-success"><span class="glyphicon glyphicon-picture"></span></button>';
                    var button = $(markup).appendTo(cell);
                    var url = String.format('/api/headshot_download?token={0}&id={1}', session, value['id']);
                    button.attr('href', url);

                    //Bind the button to open a bootbox alert with the image.
                    button.click(function() {
                        var markup = String.format('<div style="text-align:center;"><h2>Headshot</h2><hr><img src="{0}"></div>', $(this).attr('href'));
                        bootbox.alert(markup);
                    });
                }
                return;

            case 'model':
                //If this is a form, continue as a text entry
                if (empty) {
                    property['type'] = 'text';
                    break;
                }

                //If the reference model is null (meaning it has been removed), let the user know and keep on truckin'.
                if (value == null) {
                    cell.append('<em>removed</em>')
                    return;
                }

                //Generate the button text based on what foreign model is being loaded.
                var text = 'View'
                if (property.model == 'client') {text = value['name_first'] + ' ' + value['name_last'];}

                //Put it all together into a purple button sandwich.
                var entry = $(String.format('<button class="btn btn-sm btn-success" model="{0}" modelid="{1}">{2}</button>',
                        property.model,
                        value.id,
                        text
                    )).appendTo(cell);
                    entry.css('width', '100%');
                    entry.click(function() {
                        data_viewRecord(
                            $(this).attr('model'),
                            $(this).attr('modelid')
                        )
                    });
                return;

        }

        //Preparing for initialization of the xeditable.
        var editor = $('<a href="#"></a>').appendTo(cell);
        var url = String.format('/api/{0}_consoleupdate?token={1}', data_current, session)
        var options = {
            'type': property.type,
            'name': property.name,
        };

        //Complete the options if this isn't destined for a form
        if (!empty) {
            options['url'] = url;
            options['pk'] = record.id;
            options['value'] = value;
        }


        //This switch tweaks the xeditable options for some of the types.
        switch (property.type) {

            case 'select':
                options['source'] = property.options;
                break;

            case 'password':
                options['emptytext'] = 'Click to Change';
                break;

            case 'textarea':
                options['display'] = function(value, sourceData) {
                    if (value.length > 0) {
                        $(this).text('. . .');
                    }
                };
                break;

            case 'combodate':
                options['format'] = 'YYYY-MM-DD';
                options['inputclass'] = 'input-sm'
                options['combodate'] = {
                    'minYear': 1900,
                    'maxYear': new Date().getFullYear()
                };
                break;

        }

        //If this form is destined for a form, reap its ability to send requests.
        if (empty) {
            delete options['url'];
            delete options['pk'];
            delete options['value'];
        }

        //Initialize the xeditable.
        editor.editable(options);
    }

    function data_viewRecord(model, modelid) {
        //Hide the modal and clear its contents
        $('#data_modalView').modal('hide');
        $('#data_modalViewTable').children().each(function() {
            $(this).remove();
        });
        $('#data_modalView').modal('show');
        $.ajax({
            'url': String.format('/api/{0}_get?token={1}&id={2}', model, session, modelid),
            'dataType': 'json',
            'error': function() {
                $('#data_modalView').modal('hide');
                bootbox.alert('An error occurred trying to load the record.');
            },
            'success': function(data, status, xhr) {
                var table = $('#data_modalViewTable');

                for (i in data_config['properties'][model]) {
                    var property = data_config['properties'][model][i];
                    table.append(String.format('<tr><td><strong>{0}</strong></td><td>{1}</td></tr>',
                        property['name'].toUpperCase(),
                        data[property['name']]
                    ));
                }
            }
        });
    }

    function data_createRecord(model) {
        //Gather necessary data.
        var properties = data_config['properties'][model];
        var table = $('#data_modalCreateRecordTable');

        //Clear previous information from the modal.
        data_modalCreateRecordFields = [];
        table.children().each(function() {
            $(this).remove();
        });

        //Iterate through properties and add to table (with garnishes).
        for (i in properties) {
            var property = properties[i];

            //If property is not meant to be filled out (such as record ID), then continue without it.
            if (property['required'] == null) {continue;}

            //Create an empty row for placing elements in
            var row = $('<tr></tr>').appendTo(table);

            //Add the property name; in bolded caps.
            row.append(String.format('<td><strong>{0}</strong></td>', property['name'].toUpperCase()));

            //Make the cell, pass it to the constructor, and profit.
            var cell = $('<td></td>').appendTo(row);
            data_makeEditable(cell, null, property, true);

            //Create a cell for the indicator.
            var cell = $('<td></td>').appendTo(row);

            //If it's a required property, append a glyphicon.
            if (property['required'] == true) {
                cell.append('<span class="glyphicon glyphicon-exclamation-sign"></span>');
            }
        }

        //Show off the finished product!
        $('#data_modalCreateRecord').modal('show');
        
        //Give the submit button something to do.
        $('#data_buttonCreateRecordSubmit').click(function() {
            //Disabled the button to prevent duplicate requests.
            $('#data_buttonCreateRecordSubmit').prop('disabled', true);

            //Collect values from form editables and inject session token.
            var data = $('#data_modalCreateRecordTable .editable').editable('getValue');
            data['token'] = session;

            //Send it off!
            var url = String.format('/api/{0}_create', model);
            $.ajax({
                'url': url,
                'type': 'POST',
                'dataType': 'json',
                'data': data,

                //If successful, close the modal and re-enabled the button.
                'success': function() {
                    $('#data_modalCreateRecord').modal('hide');
                },

                //If not successful, do the error thang.
                'error': data_errorHandler,

                //On completion, enable the button.
                'complete': function() {
                    $('#data_buttonCreateRecordSubmit').prop('disabled', false);
                }
            });
        });
    }

    function data_deleteRecords(model, modelids) {
        //'modelids' should be an array of ids to remove.

        //Disable the delete button to prevent duplicate requests being made.
        $('#data_buttonDeleteRecord').prop('disabled', true);

        var url = String.format('/api/{0}_remove', model)
        $.ajax({
            'url': url,
            'type': 'POST',
            'data': {
                'token': session,
                'ids': JSON.stringify(modelids),
            },

            //If deletion succeeds, remove the rows from the table.
            'success': function() {
                for (i in modelids) {
                    var id = modelids[i];
                    $('tr#' + id).remove();
                }
            },

            //If deletion fails, use the warning template. :P
            'error': data_errorHandler,

            //On completion, re-enable the delete button.
            'complete': function() {
                $('#data_buttonDeleteRecord').prop('disabled', false);
            }
        });
    }

    //Bind the delete button to the deleteRecords function (sorta).
    $('#data_buttonDeleteRecord').click(function() {
        var modelids = [];

        //Iterate through checked boxes and push their row ids to the array.
        $('.data_tableCheck:checked').each(function() {
            modelids.push($(this).val());
        });

        //If nothing is selected, return.
        if (modelids.length == 0) {return;}

        //Do the deed.
        data_deleteRecords(data_current, modelids);
    });

    
    //Bind the create button to the createRecord function (sorta).
    $('#data_buttonCreateRecord').click(function() {
        var model = data_current;
        data_createRecord(model);
    });    

    $(document).ready(function() {
        //Disable the model controls
        $('.load-disable').prop('disabled', true);

        //Load up the configuartion
        $.ajax({
            'url': '/static/data/data-config.json',
            'dataType': 'json',
            'success': function(data, status, xhr) {
                data_config = data;
                data_init();
            },
            'error': function(xhr, status, error) {
                bootbox.alert(String.format('The data view configuration file failed to load. Try reloading the page.<br><br><div class="alert alert-warning">{0}</div>', error));
            }
        });
    });
    
</script>