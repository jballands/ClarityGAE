<div class="tab-pane fade" id="tab-data">
    <br>

    <div class="row well well-sm">
        <div class="col-md-10 col-md-offset-1" style="text-align: center;" id="data_buttonRow">
            Click to change data type or reload:&nbsp;
            <button class="btn btn-primary" disabled>_______</button>
        </div>
    </div>

    <hr>

    <div class="row">
        <div class="col-md-10 col-md-offset-1" style="text-align: center;">
            <button class="btn btn-block btn-primary" id="data_buttonModal" disabled>Create New</button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-10 col-md-offset-1" style="text-align: center;">
            <button class="btn btn-block btn-danger" id="data_buttonDelete" disabled>Delete Selected</button>
        </div>
    </div>

    <hr>

    <div class="loader" id="data_loader" style="margin-left:auto;margin-right:auto;" hidden>
    </div>

    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-condensed table-bordered" id="data_table">
                    <thead id="data_tableHead">
                    </thead>
                    <tbody id="data_tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="data_modalRecord" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Insert a New Record</h4>
            </div>
            <div class="modal-body">
                <blockquote><em>Be aware that newly inserted records may take some time to propagate through the database (typically less than 1 minute).</em></blockquote>
                <table class="table table-bordered table-striped" id="data_modalRecordTable">
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="data_buttonModalRecordSubmit">Submit</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="data_modalView" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">View a Linked Record</h4>
            </div>
            <div class="modal-body">
                <table class="table table-bordered table-striped" id="data_modalViewTable">
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style type="text/css">
    th, td {
        text-align: center;
    }
</style>

<script type="text/javascript">
    var data_config = {};
    var data_current = '';
    var currentModel = '';

    function data_errorHandler(xhr, status, error) {
        var template = '<h4>An error occurred while trying to process your request.</h4><br><div class="alert alert-warning"><small><em>{0}</em><br>{1}</small></div>';
        bootbox.alert(String.format(template, status, error));
    }

    function data_init() {
        $('#data_buttonRow .btn').remove();

        for (i in data_config.models) {
            var model = data_config.models[i];
            var modelName = data_config.names[model];
            var markup = String.format('<button class="buttonModelLoad btn btn-default" model="{0}">{1}</button>&nbsp;', model, modelName);
            $('#data_buttonRow').append(markup);
        }

        $('.buttonModelLoad').click(function() {
            data_dataLoad($(this).attr('model'));
        });
    }

    function data_dataLoad(model) {
        $('.buttonModelLoad').prop('disabled', true);
        $('#data_tableHead').children().remove();
        $('#data_tableBody').children().remove();
        $('#data_loader').prop('hidden', false);

        if (model == null) {
            model = data_current;
        }

        data_current = model;

        var url = String.format('/api/{0}_get', model);

        $.ajax({
            'url': url,
            'dataType': 'json',
            'data': {
                'token': session
            },
            'success': data_dataParse,
            'error': data_errorHandler,
            'complete': function() {
                $('.buttonModelLoad').prop('disabled', false);
                $('#data_loader').prop('hidden', true);
            }
        })
    }

    function data_dataParse(data, status, xhr) {
        var model = data_current;
        var properties = data_config.properties[model];

        //Grab table head and body elements.
        var tableHead = $('#data_tableHead');
        var tableBody = $('#data_tableBody');

        //Add head cell for checkbox column.
        tableHead.append('<td>&nbsp;<span class="glyphicon glyphicon-ok"></span>&nbsp;</td>');

        //Iterate and insert head cells.
        for (i in properties) {
            var property = properties[i];
            var markup = String.format('<th><small>{0}</small></th>', property.name.toUpperCase());
            tableHead.append(markup);
        }

        //Let's start loading the data into the table! ;D
        for (i in data) {
            var record = data[i];

            //Create a row with the id the same as the record. Makes for easy handling later on.
            var row = $('<tr></tr>').appendTo(tableBody);
            row.attr('id', record.id);

            //Insert a cell with a checkbox...
            var cell = $('<td></td>').appendTo(row);
            var checkbox = $('<input type="checkbox" class="data_tableCheck">').appendTo(cell);
            checkbox.attr('value', record.id);

            //Let's iterate over the properties again so we can get their values!
            for (j in properties) {
                var property = properties[j];
                var cell = $('<td></td>').appendTo(row);

                //Hand it off to another function for the sake of modularity.
                data_makeEditable(cell, record, property);
            }
        }
    }

    function data_makeEditable(cell, record, property) {
        var value = record[property.name];

        //Convert booleans to strings, because ceditable is kind of a witch.
        if (typeof(value) == 'boolean') {
            value = JSON.stringify(value);
        }

        //This switch will deal with properties that can't or shouldn't be edited in the console.
        switch (property.type) {

            case 'readonly':
                //Create a readonly text entry that allows the user to easily copy the id of the record.
                var entry = $('<input type="text" readonly/>').appendTo(cell)
                entry.val(value);
                entry.css('width', '100%');
                entry.tooltip({
                    'placement': 'right',
                    'title': 'Click, then Ctrl+C to copy'
                });
                //Make it auto-select all text when clicked on.
                entry.click(function() { $(this).select(); });
                return;

            case 'headshot':
                if (value == null) {
                    cell.append('<span class="glyphicon glyphicon-remove"></span>');
                }
                else {
                    var markup = '<button class="btn btn-sm btn-info"><span class="glyphicon glyphicon-picture"></span></button>';
                    var button = $(markup).appendTo(cell);
                    //button.attr('model', data_current);
                    //button.attr('modelid', )
                }
                return;

            case 'model':
                //Generate the button text based on what foreign model is being loaded.
                var text = 'View'
                if (property.model == 'client') {text = value.name_first + ' ' + value.name_last;}

                //Put it all together into a purple button sandwich
                var entry = $(String.format('<button class="btn btn-sm btn-info" model="{0}" modelid="{1}">{2}</button>',
                        property.model,
                        value.id,
                        text
                    )).appendTo(cell);
                    entry.css('width', '100%');
                    entry.click(function() {
                        data_viewModel(
                            $(this).attr('model'),
                            $(this).attr('modelid')
                        )
                    });
                return;

        }

        //Preparing for initialization of the xeditable.
        var editor = $('<a href="#"></a>').appendTo(cell);
        var url = String.format('/api/{0}_consoleupdate?token={1}', data_current, session)
        var options = {
            'url': url,
            'type': property.type,
            'pk': record.id,
            'name': property.name,
            'value': value,
        };

        //This switch tweaks the xeditable options for some of the types.
        switch (property.type) {

            case 'select':
                options['source'] = property.options;
                break;

            case 'password':
                options['emptytext'] = 'Click to Change';
                break;

            case 'textarea':
                options['display'] = function(value, sourceData) {
                    if (value.length > 0) {
                        $(this).text('. . .');
                    }
                };
                break;

            case 'datetime':
                options['format'] = 'yyyy-mm-dd hh:ii:ss'
                break;

        }

        //Initialize the xeditable.
        editor.editable(options);
    }

    function data_makeButtons() {
        var buttonGroup = $('#data_buttonGroup');
        for (i in models) {
            var model = models[i];
            var modelName = modelNames[model];
            //alert(modelName);
            buttonGroup.append(String.format(
                '<label class="btn btn-primary btn-lg data_buttonModel" model="{0}">\
                    <input type="radio"> {1}\
                </label>',
            model, modelName));
        }

        $('.data_buttonModel').click(function() {
            var model = $(this).attr('model');
            currentModel = model;
            data_buttonModelPress();
        });
    }

    function data_parseData(data, status, xhr) {
        $('#data_buttonModal').attr('disabled', false);
        var tableBody = $('#data_tableBody');
        var properties = modelProperties[currentModel];
        for (i in data) {
            var instance = data[i];
            tableBody.append(String.format('<tr id="{0}"></tr>', instance['id']));
            var row = $('#' + instance['id']);

            var cell = $('<td></td>').appendTo(row);
            var checkbox = $('<input type="checkbox" class="data_check">').appendTo(cell);
            checkbox.attr('value', instance['id'])

            for (j in properties) {
                var key = properties[j][0];
                var value = instance[key];
                var type = properties[j][1];
                var cell = $('<td></td>').appendTo(row);

                if (key == 'id') {
                    var entry = $(String.format('<input type="text" class="data_tableID" value="{0}" readonly></input>', value)).appendTo(cell);
                    entry.css('width', '100%');
                    entry.tooltip({
                        'placement': 'right',
                        'title': 'Ctrl+C to copy'
                    });
                }
                else if (type == "model"){
                    var entry = $(String.format('<button class="btn btn-sm btn-info" model="{0}" modelid="{1}">{2} {3}</button>',
                        properties[j][2],
                        value['id'],
                        value['name_first'],
                        value['name_last']
                    )).appendTo(cell);
                    entry.css('width', '100%');
                    entry.click(function() {
                        data_viewModel(
                            $(this).attr('model'),
                            $(this).attr('modelid')
                        )
                    });
                }
                else {
                    editor = $('<a href="#" class="data_tableElement"></a>').appendTo(cell);
                    var options = {
                        'url': String.format('/api/{0}_consoleupdate?token={1}', currentModel, session),
                        'type': type,
                        'pk': instance['id'],
                        'name': key,
                        'value': value,
                    };

                    switch (type) {
                        case 'select':
                            options['source'] = properties[j][2];
                            break;
                        case 'password':
                            options['emptytext'] = 'Click to Change';
                            break;
                        case 'textarea':
                            options['display'] = function(value, sourceData) {
                                if (value.length > 0) {
                                    $(this).text('. . .');
                                }
                            };
                            break;
                        case 'datetime':
                            //if (value == null){
                                //options['value'] = '';
                            //}
                            options['format'] = 'yyyy-mm-dd hh:ii:ss'
                            break;
                    }

                    switch (typeof(value)) {
                        case 'boolean':
                            options['value'] = JSON.stringify(value);
                            break;
                    }

                    editor.editable(options);
                }
            }
        }

        $('.data_check').click(function () {
            var button = $('#data_buttonDelete');
            var n = $('.data_check:checked').length;
            if (n > 0) {
                button.attr('disabled', false);
            }
            else {
                button.attr('disabled', true);
            }
        });

        $('.data_tableID').hover(function() {
            $(this).select();
        });
    }

    function data_enableControls() {
        $('#data_buttonRefresh').prop('disabled', false).click(data_buttonModelPress);
        $('.data_buttonModel').prop('disabled', false);
        $('#data_progressBar').css('width', '0%');
    }

    function data_buttonModelPress() {
        $('#data_buttonRefresh').prop('disabled', true);
        $('.data_buttonModel').prop('disabled', true);
        $('#data_progressBar').css('width', '100%');
        $('#data_tableHead').empty();
        $('#data_tableBody').empty();

        var model = currentModel;
        var properties = modelProperties[model];
        var head = '<td>&nbsp;<span class="glyphicon glyphicon-ok"></span>&nbsp;</td>';

        for (i in properties) {
            var property = properties[i][0];
            head += String.format('<td><strong>{0}</strong></td>', property.toUpperCase());
        }

        $('#data_tableHead').append(head);

        $.ajax({
            'url': String.format('/api/{0}_get?token={1}', model, session),
            'dataType': 'json',
            'success': data_parseData,
            'complete': data_enableControls
        })
    }

    $('#data_buttonDelete').click(function() {
        var ids = []
        checkboxes = $('.data_check:checked').each(function() {
            ids.push($(this).val());
        });
        $('#data_buttonDelete').attr('disabled', true);
        $.ajax({
            'url': String.format('/api/{0}_remove?token={1}&ids={2}', currentModel, session, JSON.stringify(ids)),
            'success': function() {
                $('.data_check:checked').each(function() {
                    $(this).parent().parent().remove();
                });
            },
            'error': function() {
                bootbox.alert('Error encountered while delete records');
                $('#data_buttonDelete').attr('disabled', false);
            },
        });
    });

    var data_modalRecordFields = [];

    $('#data_buttonModal').click(function() {
        var model = currentModel;
        var properties = modelProperties[model];
        var table = $('#data_modalRecordTable')

        data_modalRecordFields = [];
        table.children().each(function() {
            $(this).remove();
        });

        for (i in properties) {
            if(properties[i][3] == null){continue;}
            var key = properties[i][0];
            var type = properties[i][1];
            var row = $('<tr></tr>').appendTo(table);

            if(type=='null'){continue;}
            if(type=='model'){type='text';}
            row.append(String.format('<td><strong>{0}</strong></td>', key.toUpperCase()));

            var cell = $('<td></td>').appendTo(row);
            var editor = $('<a href="#"></a>').appendTo(cell);
            var options = {
                'type': type,
                'name': key,
            };

            switch (type) {
                case 'select':
                    options['source'] = properties[i][2];
                    break;
            }

            switch (key) {
                case 'admin':
                    options['admin'] = false;
                    break;
            }

            data_modalRecordFields.push(editor.editable(options));

            if (properties[i][3]) {
                cell.append('&nbsp;&nbsp;<span class="glyphicon glyphicon-exclamation-sign"></span>');
            }
        }
        $('#data_modalRecord .glyphicon').tooltip({
            'placement': 'right',
            'title': 'Required field'
        })
        $('#data_modalRecord').modal('show');
    });
    
    $('#data_buttonModalRecordSubmit').click(function() {
        $(this).prop('disabled', true);
        var data = $('#data_modalRecord .editable').editable('getValue');
        $.ajax({
            'url': String.format('/api/{0}_create?token={1}', currentModel, session),
            'dataType': 'json',
            'data': data,
            'success': function() {
                $('#data_buttonModalRecordSubmit').prop('disabled', false);
                $('#data_modalRecord').modal('hide');
            },
            'error': function() {
                bootbox.alert('An error occurred trying to insert the new record. Perhaps you forgot a required field?');
                $('#data_buttonModalRecordSubmit').prop('disabled', false);
            }
        })
    });

    function data_viewModel(model, modelid) {
        $('#data_modalView').modal('hide');
        $('#data_modalViewTable').children().each(function() {
            $(this).remove();
        });
        $('#data_modalView').modal('show');
        $.ajax({
            'url': String.format('/api/{0}_get?token={1}&id={2}', model, session, modelid),
            'dataType': 'json',
            'error': function() {
                $('#data_modalView').modal('hide');
                bootbox.alert('An error occurred trying to load the record.');
            },
            'success': function(data, status, xhr) {
                var table = $('#data_modalViewTable');

                for (i in modelProperties[model]) {
                    var property = modelProperties[model][i];
                    table.append(String.format('<tr><td><strong>{0}</strong></td><td>{1}</td></tr>',
                        property[0].toUpperCase(),
                        data[property[0]]
                    ));
                }
            }
        });
    }

    $(document).ready(function() {
        $.ajax({
            'url': '/static/data/data-config.json',
            'dataType': 'json',
            'success': function(data, status, xhr) {
                data_config = data;
                data_init();
            },
            'error': function(xhr, status, error) {
                bootbox.alert(String.format('The data view configuration file failed to load. Try reloading the page.<br><br><div class="alert alert-warning">{0}</div>', error));
            }
        });
    });
    
</script>