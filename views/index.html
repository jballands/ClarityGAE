<html>
    <head>
        <title>Clarity Database Gateway</title>
        {% include '_header.html' %}
        {% include '_footer.html' %}

        <script src="/static/js/TweenMax.min.js"></script>
    </head>
    <body>
        <style>
            body {
                background-image: url('/static/image/cubes_@2X.png');
            }
        </style>

        <div class="row">
            <div class="col-md-12">
                <div class="text-center" id="titlebar">
                    <img src="/static/image/ClarityLogo_padded_white.svg" style="height: 100%;">
                    <button class="btn btn-danger navbar-right" id="logoutButton">Logout</button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <iframe id="consoleframe" style="width:100%;height:100%;" hidden>
                </iframe>
            </div>
        </div>

        <style>
            #titlebar {
                width: 100%;
                height: 38%;
                background-color: #0091f6;
                border: none;
                margin-bottom: 0;

                position: relative;
            }

            #logoutButton {
                height: 100%;
                position: absolute;
                right:0px;
                opacity: 0.0;
            }

            iframe {
                border: none;
            }
        </style>

        <div id="logindiv">
            <br>
            <form id="loginform" class="form-horizontal">

                <div class="row">
                    <div class="col-md-10 col-md-offset-1">
                        <h2 class="form-signin-heading">Log in to the console</h2>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-10 col-md-offset-1">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Username" name="username" autofocus required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-10 col-md-offset-1">
                        <div class="form-group">
                            <input type="password" class="form-control" placeholder="Password" name="password" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-10 col-md-offset-1">
                        <div class="form-group">
                            <button class="btn btn-lg btn-primary btn-block" type="submit">Submit</button>
                        </div>
                    </div>
                </div>
                <input type="text" name="console" value="true" hidden>
            </form>
        </div>

        <script type="text/javascript">
            var session = '';

            var titlebarContracted = '50px';
            var titlebarExpanded = '38%'

            function loginSuccess(data, status, xhr) {
                session = data['token'];
                $.cookies.set('clarity-console-session', session);
                //window.location = '/console';

                $('#logindiv').hide();
                //$('#consoleframe').show();
                $('#titlebar').animate({'height': titlebarContracted}, complete=function() {
                    //$('#logoutButton').show()
                    $('#logoutButton').animate({'opacity': 1.0});
                    $('#consoleframe').show().attr('src', '/console')
                })
            }

            function loginError(xhr, status, error) {
                if(status == 'timeout'){
                    bootbox.alert('Oops! Your login request timed out; try again.');
                    return
                }
                bootbox.alert('The password and/or username provided are invalid.');
                $('#loginform').children().attr('disabled', false);
            }

            function loginComplete() {
                //$('#loginform').children().attr('disabled', false);
            }

            //$('#titlebar').css('height', '1.5em')

            $('#loginform').submit(function() {
                var data = $(this).serialize();
                $(this).children().attr('disabled', true);
                $.ajax({
                    'url': '/api/session_begin',
                    'method': 'post',
                    'dataType': 'json',
                    'data': data,
                    'success': loginSuccess,
                    'error': loginError,
                    'complete': loginComplete
                });
                return false;
            });


            function logoutComplete() {
                //$('#logoutButton').hide();
                $('#logoutButton').animate({'opacity': 0.0}, complete=function() {
                    $('#titlebar').animate({'height': '38%'}, complete=function() {
                        $('input[name="password"]').val('')
                        $('#logindiv').show()
                    });
                });
            }

            $('#logoutButton').click(function() {
                $('#consoleframe').attr('src', '').hide();

                var data = {
                    'token': session
                }

                $.ajax({
                    'url': '/api/session_end',
                    'method': 'POST',
                    'data': data,
                    'complete': logoutComplete
                });
            });

            $(document).ready(function() {
                //do nothing :v
            });
        </script>

        <div style="position:absolute;bottom:0px;" id="footer">
            Styled using <a href="http://getbootstrap.com/">Bootstrap 3.1.0</a>, <a href="http://bootswatch.com/cosmo/">Cosmo</a>, and <a href="http://subtlepatterns.com/">Subtle Patterns</a>.
        </div>
    </body>
</html>